<link href="@Url.Content("~/Scripts/dynatree-1.2.0/Skin/ui.dynatree.css")" rel="stylesheet" type="text/css"  /> 
<script src="@Url.Content("~/Scripts/jquery-ui-1.8.11.min.js")" type="text/javascript"></script> 
<script src="@Url.Content("~/Scripts/jquery.cookie.js")" type="text/javascript"></script> 
<script src="@Url.Content("~/Scripts/dynatree-1.2.0/jquery.rqdynatree.js")" type="text/javascript"></script> 

<script type="text/javascript">
    function renderHtmlList(data) {
        $("#htmlList").html(data);
    }

    function renderXmlList(data, docno) {
        var xml = window.ActiveXObject ? data.xml : (new XMLSerializer().serializeToString(data));

        $("#" + docno).transform({ xmlstr: xml, xsl: HostAdress() + "/xslt/ViewTransforms/RQI2SingleItemView.xslt" });
    }
        
    function getRQItemList(node) {
        var d = HostAdress() + encodeURI("/RQItems?verb=BrowseList&queryString=$class$" + node.data.key.substring(node.data.key.indexOf('$') + 1));
                
        $.ajax({
            url: d,
            type: "GET",
            data: null,
            dataType: "html",
            success: function (data) {
                renderHtmlList(data);
                if (docNo != "") {      
                    setTimeout( function () {
                                    getOldRQItem(docNo);
                                    }, 1)
                }
            },
            error: function (xhr) {
                alert(xhr.responseText);
            }
        });
        $("#echoActive").text("" + node + " (" + node.getKeyPath() + ")");    
    }

    function getRQItem(docno, newDomElementID, oldDomElementID) {
        if ($("#" + newDomElementID).is(":empty")) {
            $("#" + newDomElementID).html("<div id='loading'><img src='" + HostAdress() + "/images/ajax-loader.gif' alt='Please Wait' /></div>");
            $.ajax({
                url: HostAdress() + "/RQItems/" + docno + "?verb=BrowseItem",
                type: "GET",
                data: null,
                dataType: "xml",
                success: function (data) {
                    renderXmlList(data, newDomElementID);
                }
            });
        }
        $("#" + oldDomElementID).toggle();
        $("#" + newDomElementID).toggle("slow");
    }

    function getOldRQItem (docno)
    {
        var eid = $('div[DocNo =' + docno +']').attr("id");

        getRQItem(docno, eid, "o"+eid);
    }

    function call(path) {
        window.location = HostAdress() + "/" + path;
    }

    function getRQKos(path, docno) {
        locPath = path;
        docNo = docno;
        ExpandPath(path);
    }

    $(function () {
        // Attach the dynatree widget to an existing <div id="tree"> element 
        // and pass the tree options as an argument to the dynatree() function:
        var urlbase = document.location.href.substring(0,document.location.href.toLowerCase().toLowerCase().indexOf("rqkos") + 5);
        
        $("#tree").dynatree({
            initAjax: { url: urlbase + '/0?verb=dt' },
            autoFocus: false,
            onLazyRead: function (node) {
                node.appendAjax({
                    url: urlbase + "/" + node.data.key.substring(0, node.data.key.indexOf('$')) + "?verb=dt",
                    data: { "key": node.data.key.substring(0, node.data.key.indexOf('$')), // Optional url arguments 
                        "mode": "all"
                    },
                    debugLazyDelay: 750
                });
            },
            onActivate: function (node) {
                // A DynaTreeNode object is passed to the activation handler 
                // Note: we also get this event, if persistence is on, and the page is reloaded. 
                getRQItemList(node);
            },
            onPostInit: function (isReloading, isError) {
                ExpandPath(locPath);
            },
            persist: true
        });
    });

    function ExpandPath(keyPath) {
        var tree = $("#tree").dynatree("getTree");
        
        tree.loadKeyPath(keyPath, function (node, status) {
            if (status == "loaded") {
                // 'node' is a parent that was just traversed. 
                // If we call expand() here, then all nodes will be expanded 
                // as we go 
                node.expand();
            } else if (status == "ok") {
                // 'node' is the end node of our path. 
                // If we call activate() or makeVisible() here, then the 
                // whole branch will be expanded now 
                getRQItemList(node);
                node.activate();
            }
        });
    }

    function renderFieldContent(data, domElementID) {
        var xml = window.ActiveXObject ? data.xml : (new XMLSerializer().serializeToString(data));

        $("#" + domElementID).transform({ xmlstr: xml, xsl: HostAdress() + "/xslt/ViewTransforms/RQItemFields.xslt" });
    }

    function callAjax(path, domElementID) {
        alert(HostAdress() + path);
        $.ajax({
            url: HostAdress() + path,
            type: "GET",
            data: null,
            dataType: "xml",
            success: function (data) {
                renderFieldContent(data, domElementID);
            }
        });
    }

    var locPath = @Html.Raw(Json.Encode(@ViewBag.locPath));
    var docNo = @Html.Raw(Json.Encode(@ViewBag.docNo));
</script> 

<div>Active node: <span id="echoActive">-</span></div> 
<div id="tree"></div>

<h3>RQItem List</h3>

<div id="htmlList"></div>