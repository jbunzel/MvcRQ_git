<link href="@Url.Content("~/Scripts/dynatree-1.2.0/Skin/ui.dynatree.css")" rel="stylesheet" type="text/css"  /> 
<script src="@Url.Content("~/Scripts/jquery-ui-1.8.11.min.js")" type="text/javascript"></script> 
<script src="@Url.Content("~/Scripts/jquery.cookie.js")" type="text/javascript"></script> 
<script src="@Url.Content("~/Scripts/dynatree-1.2.0/jquery.rqdynatree.js")" type="text/javascript"></script> 
@{
    ViewBag.Title = "Home Page";
}
<script type="text/javascript">
    $(document).ready(function () {
        //        var d = "/RQItems?verb=rqListHTML&query=bunzel";
        //        $.ajax({
        //            url: d,
        //            type: "GET",
        //            data: null,
        //            dataType: "html",
        //            success: function (data) {
        //                renderHtmlList(data);
        //            },
        //            error: function (xhr) {
        //                alert(xhr.responseText);
        //            }
        //        });
    });
    
    function renderHtmlList(data) {
        $("#htmlList").html(data);
    }

    function renderXmlList(data, docno) {
        var xml = window.ActiveXObject ? data.xml : (new XMLSerializer().serializeToString(data));
        $("#" + docno).transform({ xmlstr: xml, xsl: "/xslt/ViewTransforms/RQ2SingleItemView.xslt" });
    }

    function getRQItem(docno) {
        if ($("#" + docno).is(":empty")) {
            $.ajax({
                url: "/RQItems/" + docno,
                type: "GET",
                data: null,
                dataType: "xml",
                success: function (data) {
                    renderXmlList(data, docno);
                }
            });
        }
        $("#" + docno).toggle("slow");
    }

    function getRQKos(path, docno) {
        locPath = path;
        docNo = docno;
        ExpandPath(path);
    }

    $(function () {
        // Attach the dynatree widget to an existing <div id="tree"> element 
        // and pass the tree options as an argument to the dynatree() function: 
        $("#tree").dynatree({
            initAjax: { url: '/dt/RQKos/0' },
            autoFocus: false,
            onLazyRead: function (node) {
                node.appendAjax({
                    url: "/dt/RQKos/" + node.data.key.substring(0, node.data.key.indexOf('$')),
                    data: { "key": node.data.key.substring(0, node.data.key.indexOf('$')), // Optional url arguments 
                        "mode": "all"
                    },
                    debugLazyDelay: 750
                });
            },
            onActivate: function (node) {
                // A DynaTreeNode object is passed to the activation handler 
                // Note: we also get this event, if persistence is on, and the page is reloaded. 
                // alert("You activate /RQItems?verb=rqListHTML&query=$class$" + node.data.key.substring(node.data.key.indexOf('$')+1));
                alert(encodeURI("/RQItems?verb=rqListHTML&query=$class$" + node.data.key.substring(node.data.key.indexOf('$') + 1)));
                var d = encodeURI("/RQItems?verb=rqListHTML&query=$class$" + node.data.key.substring(node.data.key.indexOf('$') + 1));
                $.ajax({
                    url: d,
                    type: "GET",
                    data: null,
                    dataType: "html",
                    success: function (data) {
                        renderHtmlList(data);
                        if (docNo != "") {      
                            setTimeout( function () {
                                            getRQItem(docNo);
                                         }, 1)
                        }
                    },
                    error: function (xhr) {
                        alert(xhr.responseText);
                    }
                });
                $("#echoActive").text("" + node + " (" + node.getKeyPath() + ")");
            },
            onPostInit: function (isReloading, isError) {
                ExpandPath(locPath);
            },
            persist: true
        });
    });

    function ExpandPath(keyPath) {
        var tree = $("#tree").dynatree("getTree");
        tree.loadKeyPath(keyPath, function (node, status) {
            if (status == "loaded") {
                // 'node' is a parent that was just traversed. 
                // If we call expand() here, then all nodes will be expanded 
                // as we go 
                node.expand();
            } else if (status == "ok") {
                // 'node' is the end node of our path. 
                // If we call activate() or makeVisible() here, then the 
                // whole branch will be expanded now 
                node.activate();
            }
        });
    }

    var locPath = @Html.Raw(Json.Encode(@ViewBag.locPath));
    var docNo = @Html.Raw(Json.Encode(@ViewBag.docNo));
</script> 
<h2>@ViewBag.Message</h2>
<p>To learn more about ASP.NET MVC visit <a href="http://asp.net/mvc" title="ASP.NET MVC Website">http://asp.net/mvc</a>.</p>
<h3>RQKos</h3>
<div>Active node: <span id="echoActive">-</span></div> 
<div id="tree"></div>
<div id="htmlList"></div>
@*@Html.Partial("~/Views/RQItems/Shared/XmlViewer.cshtml") Serialization of RQKosBranch not yet implemented
*@
@Html.Partial("~/Views/RQItems/Shared/JsonViewer.cshtml")